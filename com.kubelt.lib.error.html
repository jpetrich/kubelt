<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" content="text/html" http-equiv="Content-Type" />
		<meta content="" name="description" />
		<title>Kubelt SDK Reference</title>
 		<link rel="stylesheet" type="text/css" href="css/shCore.css" />
		<style type="text/css">.syntaxhighlighter{overflow:hidden !important;}</style>
		<link rel="stylesheet" type="text/css" href="css/shThemeMarginalia.css" />
		<link rel="stylesheet" type="text/css" href="css/marginalia.css" />
		<script type="text/javascript" src="js/jquery-1.7.1.min.js"></script>
		<script type="text/javascript" src="js/xregexp-min.js"></script>
		<script type="text/javascript" src="js/shCore.js"></script>
		<script type="text/javascript" src="js/shBrushClojure.js"></script>
	</head>
	<body>
		<table>
			<tr>
				<td class="docs">
					<div class="docs-header">
						<a class="anchor" href="#repl" name="repl">
							<h1 class="project-name">com.kubelt.lib.error</h1>
							<a class="toc-link" href="index.html">toc</a>
						</a>
					</div>
				</td>
				<td class="codes" />
			</tr>
			<tr>
				<td class="docs">
					<p>Error-related utilities.</p>
				</td>
				<td class="codes">
					<pre class="brush: clojure">(ns com.kubelt.lib.error
  {:copyright &quot;Â©2022 Proof Zero Inc.&quot; :license &quot;Apache 2.0&quot;}
  (:require
   [malli.core :as mc]
   [malli.error :as me])
  (:require
   [com.kubelt.spec.error :as spec.error]))</pre>
				</td>
			</tr>
			<tr>
				<td class="docs">
					<p>TODO define catalog of errors TODO use cognitect.anomalies? TODO examine truss https://github.com/ptaoussanis/truss</p>
				</td>
				<td class="codes">
					<pre class="brush: clojure"></pre>
				</td>
			</tr>
			<tr>
				<td class="docs">
					<p>TODO flesh out error spec in com.kubelt.spec.error</p>
				</td>
				<td class="codes">
					<pre class="brush: clojure"></pre>
				</td>
			</tr>
			<tr>
				<td class="docs">
					<h2>error?</h2>
				</td>
				<td class="codes">
					<pre class="brush: clojure"></pre>
				</td>
			</tr>
			<tr>
				<td class="docs">
					<p>Is the given value a Kubelt error map?</p>
				</td>
				<td class="codes">
					<pre class="brush: clojure">(defn error?
  [x]
  (and
   (map? x)
   (= :kubelt.type/error (get x :com.kubelt/type))))</pre>
				</td>
			</tr>
			<tr>
				<td class="docs">
					<h2>error</h2>
				</td>
				<td class="codes">
					<pre class="brush: clojure"></pre>
				</td>
			</tr>
			<tr>
				<td class="docs">
					<p>Return a Kubelt error map wrapping the given error.</p>
				</td>
				<td class="codes">
					<pre class="brush: clojure">(defn error
  ([message]
   (error message nil))
  ([message data]
   (error message data nil))
  ([message data cause]
   (cond-&gt;
    {:com.kubelt/type :kubelt.type/error
     :error message}
     data (assoc :data data)
     cause (assoc :cause cause))))</pre>
				</td>
			</tr>
			<tr>
				<td class="docs">
					<h2>explain</h2>
				</td>
				<td class="codes">
					<pre class="brush: clojure"></pre>
				</td>
			</tr>
			<tr>
				<td class="docs">
					<p>Return human-friendly description of why some value doesn't conform to the provided schema.</p>
				</td>
				<td class="codes">
					<pre class="brush: clojure">(defn explain
  [schema value]
  (let [explain (-&gt; schema (mc/explain value) me/humanize)]
    (merge
     {:com.kubelt/type :kubelt.type/error}
     (when (:title (mc/properties schema))
       {:title (:title (mc/properties schema))})
     {:error explain})))</pre>
				</td>
			</tr>
			<tr>
				<td class="docs">
					<h2>conform</h2>
				</td>
				<td class="codes">
					<pre class="brush: clojure"></pre>
				</td>
			</tr>
			<tr>
				<td class="docs">
					<p>Check that data conforms to the given spec, and execute the supplied body when it does. Otherwise, return an error map that explains the issue(s) that were detected in the data.</p>
				</td>
				<td class="codes">
					<pre class="brush: clojure">(defmacro conform
  [spec data &amp; body]
  `(if-not (mc/validate ~spec ~data)
     (explain ~spec ~data)
     (do ~@body)))</pre>
				</td>
			</tr>
			<tr>
				<td class="docs">
					<h2>conform*</h2>TODO write some tests
				</td>
				<td class="codes">
					<pre class="brush: clojure"></pre>
				</td>
			</tr>
			<tr>
				<td class="docs">
					<p>Check that pairs of specs and data are all valid, and if all data matches the provided specs then execute the provided body. Otherwise, an error is returned that describes the errors found in the first data that failed validation.</p>
				</td>
				<td class="codes">
					<pre class="brush: clojure">(defmacro conform*
  [&amp; args]
  (let [guards# (distinct (butlast args))
        body# (last args)
        check-for (fn [msg# spec# data#]
                    `(when-not (mc/validate ~spec# ~data#)
                      (let [err# (explain ~spec# ~data#)]
                        (throw (ex-info msg# err#)))))]
    ;; Validate that there's at least one guard tuple: [spec data].
    (check-for &quot;invalid guards&quot; spec.error/guards guards#)
    ;; Validate that a body to execute was provided.
    (check-for &quot;invalid body&quot; spec.error/body body#)
    ;; Generate the output form.
    (loop [guards# guards#
           body# body#]
      (if (empty? guards#)
        (do body#)
        (let [[spec# data#] (first guards#)]
          (recur (rest guards#)
                 `(if-not (mc/validate ~spec# ~data#)
                    (explain ~spec# ~data#)
                    ~body#)))))))</pre>
				</td>
			</tr>
			<tr>
				<td class="docs">
					
				</td>
				<td class="codes">
					<pre class="brush: clojure">(comment
  (require '[com.kubelt.spec.rpc :as spec.rpc])
  (conform* [spec.rpc/path [:eth :sync]] [spec.rpc/path [:web-3 :sha-3]] :foo)
  (conform* [spec.rpc/path [:eth :sync]] [spec.rpc/path [:web-3 :sha-3]] (+ 1 2))

  (require '[com.kubelt.spec.rpc.client :as spec.rpc.client])
  (conform* [spec.rpc.client/client {}] :test)
  (macroexpand '(conform* [spec.rpc.client/client {}] :test))
  )</pre>
				</td>
			</tr>
			<tr>
				<td class="docs">
					<h2>from-obj</h2>
				</td>
				<td class="codes">
					<pre class="brush: clojure"></pre>
				</td>
			</tr>
			<tr>
				<td class="docs">
					<p>Return an error map from a js/Error object.</p>
				</td>
				<td class="codes">
					<pre class="brush: clojure">#?(:cljs
  (defn from-obj
    [o]
    (let [message (.-message o)]
      (error message))))</pre>
				</td>
			</tr>
			<tr>
				<td class="spacer docs">&nbsp;</td>
				<td class="codes" />
			</tr>
		</table>
		<div class="footer">Generated by <a href="https://github.com/captain-porcelain/sidenotes">Sidenotes</a>.&nbsp;&nbsp;Syntax highlighting provided by Alex Gorbatchev's <a href="http://alexgorbatchev.com/SyntaxHighlighter/">SyntaxHighlighter</a>
		</div>
		<script type="text/javascript" src="js/app.js"></script>
	</body>
</html>
