<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" content="text/html" http-equiv="Content-Type" />
		<meta content="" name="description" />
		<title>Kubelt SDK Reference</title>
 		<link rel="stylesheet" type="text/css" href="css/shCore.css" />
		<style type="text/css">.syntaxhighlighter{overflow:hidden !important;}</style>
		<link rel="stylesheet" type="text/css" href="css/shThemeMarginalia.css" />
		<link rel="stylesheet" type="text/css" href="css/marginalia.css" />
		<script type="text/javascript" src="js/jquery-1.7.1.min.js"></script>
		<script type="text/javascript" src="js/xregexp-min.js"></script>
		<script type="text/javascript" src="js/shCore.js"></script>
		<script type="text/javascript" src="js/shBrushClojure.js"></script>
	</head>
	<body>
		<table>
			<tr>
				<td class="docs">
					<div class="docs-header">
						<a class="anchor" href="#repl" name="repl">
							<h1 class="project-name">com.kubelt.car.file</h1>
							<a class="toc-link" href="index.html">toc</a>
						</a>
					</div>
				</td>
				<td class="codes" />
			</tr>
			<tr>
				<td class="docs">
					<p>Support for working with CAR-format files.</p>
				</td>
				<td class="codes">
					<pre class="brush: clojure">(ns com.kubelt.car.file
  {:copyright &quot;Â©2022 Kubelt, Inc.&quot; :license &quot;Apache 2.0&quot;}
  #_(:require
   [&quot;@ipld/car&quot; :as ipld.car :refer [CarReader CarWriter]]
   [&quot;fs&quot; :as fs]
   [&quot;stream&quot; :as stream :refer [Readable]])
  (:require
   [cljs.core.async :as async :refer [chan go &lt;! &gt;!]]
   [cljs.core.async.interop :refer-macros [&lt;p!]])
  (:require
   [com.kubelt.car.build :as car.build]
   [com.kubelt.lib.bag.check :as bag.check]
   [com.kubelt.lib.promise :as promise]
   [com.kubelt.proto.bag-io :as bag-io]))</pre>
				</td>
			</tr>
			<tr>
				<td class="docs">
					<h2>Internal</h2>
				</td>
				<td class="codes">
					<pre class="brush: clojure"></pre>
				</td>
			</tr>
			<tr>
				<td class="docs">
					<p>TODO test me (defn- make-writer   "Return a CarWriter 'channel'. A channel is a { writer:CarWriter,   out:AsyncIterable<Uint8Array> } pair. The writer side can be used to   put() blocks, while the out side of the channel emits the bytes that   form the encoded CAR archive.</p>
				</td>
				<td class="codes">
					<pre class="brush: clojure"></pre>
				</td>
			</tr>
			<tr>
				<td class="docs">
					<p>  NB: in Node.js you can use the Readable.from() API to convert the out   AsyncIterable to a standard Node.js stream, or it can be directly fed   to a stream.pipeline()."   [roots]   {:pre [(sequential? roots)]}   (let [roots (clj->js roots)         car-writer (.create CarWriter roots)]     ;; Convert to map to allow destructuring in the caller.     (js->clj car-writer :keywordize-keys true)))</p>
				</td>
				<td class="codes">
					<pre class="brush: clojure"></pre>
				</td>
			</tr>
			<tr>
				<td class="docs">
					<p> TODO figure out how we're writing CAR in-browser.  TODO test me (defn- make-file-writer   [roots file-name]   {:pre [(sequential? roots)          (string? file-name)]}   (let [{:keys [writer out]} (make-writer roots)         ;; NB: Node.js <em>only</em>.         write-stream (.createWriteStream fs file-name)]     ;; Pipe the out side of channel to a write stream.     (.pipe (.from Readable out) write-stream)     writer))</p>
				</td>
				<td class="codes">
					<pre class="brush: clojure"></pre>
				</td>
			</tr>
			<tr>
				<td class="docs">
					<p> TODO test me (defn write-car!   "Write a CAR map to the given output file."   [{:keys [kubelt.car/blocks :kubelt.car/roots] :as car} file-name]   (go     (let [writer (make-file-writer roots file-name)]       (doseq [block blocks]         (<p! (.put writer block)))       (<p! (.close writer)))))</p>
				</td>
				<td class="codes">
					<pre class="brush: clojure"></pre>
				</td>
			</tr>
			<tr>
				<td class="docs">
					<h2>CarFile</h2>Used to write a BAG to a CAR file. Implements the BagWriter protocol.<p>E.g. (def car-file (->CarFile "/my/output.car")) (def bag (-> (bag/make-bag) (add-dag ...)) (write car-file bag)</p>
				</td>
				<td class="codes">
					<pre class="brush: clojure"></pre>
				</td>
			</tr>
			<tr>
				<td class="docs">
					
				</td>
				<td class="codes">
					<pre class="brush: clojure">(defrecord CarFile [^String file-name]
  bag-io/BagWriter
  (write-bag [this bag]
    {:pre [(bag.check/bag? bag)]}
    (-&gt; (car.build/car bag)
        (promise/then
         (fn [car]
           ;; TODO do something nice and cross platform here
           ;;(write-car! car file-name))))))</pre>
				</td>
			</tr>
			<tr>
				<td class="spacer docs">&nbsp;</td>
				<td class="codes" />
			</tr>
		</table>
		<div class="footer">Generated by <a href="https://github.com/captain-porcelain/sidenotes">Sidenotes</a>.&nbsp;&nbsp;Syntax highlighting provided by Alex Gorbatchev's <a href="http://alexgorbatchev.com/SyntaxHighlighter/">SyntaxHighlighter</a>
		</div>
		<script type="text/javascript" src="js/app.js"></script>
	</body>
</html>
