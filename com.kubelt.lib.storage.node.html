<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" content="text/html" http-equiv="Content-Type" />
		<meta content="" name="description" />
		<title>Kubelt SDK Reference</title>
 		<link rel="stylesheet" type="text/css" href="css/shCore.css" />
		<style type="text/css">.syntaxhighlighter{overflow:hidden !important;}</style>
		<link rel="stylesheet" type="text/css" href="css/shThemeMarginalia.css" />
		<link rel="stylesheet" type="text/css" href="css/marginalia.css" />
		<script type="text/javascript" src="js/jquery-1.7.1.min.js"></script>
		<script type="text/javascript" src="js/xregexp-min.js"></script>
		<script type="text/javascript" src="js/shCore.js"></script>
		<script type="text/javascript" src="js/shBrushClojure.js"></script>
	</head>
	<body>
		<table>
			<tr>
				<td class="docs">
					<div class="docs-header">
						<a class="anchor" href="#repl" name="repl">
							<h1 class="project-name">com.kubelt.lib.storage.node</h1>
							<a class="toc-link" href="index.html">toc</a>
						</a>
					</div>
				</td>
				<td class="codes" />
			</tr>
			<tr>
				<td class="docs">
					<p>Support for SDK state storage in a Node.js execution context.</p>
				</td>
				<td class="codes">
					<pre class="brush: clojure">(ns com.kubelt.lib.storage.node
  {:copyright &quot;Â©2022 Proof Zero Inc.&quot; :license &quot;Apache 2.0&quot;}
  (:require
   [&quot;fs&quot; :refer [promises] :rename {promises fs-promises} :as fs]
   [&quot;path&quot; :as path])
  (:require
   [clojure.string :as cstr])
  (:require
   [cognitect.transit :as t])
  (:require
   [com.kubelt.lib.io.node :as lib.io]
   [com.kubelt.lib.path :as lib.path]
   [com.kubelt.lib.promise :as lib.promise]))</pre>
				</td>
			</tr>
			<tr>
				<td class="docs">
					
				</td>
				<td class="codes">
					<pre class="brush: clojure">(def ^:private file-name &quot;storage.json&quot;)
(def ^:private folder &quot;localstorage&quot;)</pre>
				</td>
			</tr>
			<tr>
				<td class="docs">
					<p>Return a function that stores SDK state (supplied as a map) into a node-specific storage location. This function returns a promise that resolves to map describing what was written:</p><ul><li>:path, the path to the file that was written</li><li>:data, the map of data that was written</li><li>:mode, the mode of the file that was written</li></ul><p>The path to the backing file used to store the state must be passed as the path argument.</p>
				</td>
				<td class="codes">
					<pre class="brush: clojure">(defn- make-store-fn
  [path*]
  (let [w (t/writer :json)]
    (fn [m]
      {:pre [(map? m)] :post [(lib.promise/promise? %)]}
      (let [data (t/write w m)
            mode 0640
            opts #js {:mode mode}]
        (-&gt;
         (lib.io/ensure-kubelt-dir&amp; path* folder)
         (lib.promise/then #(.writeFile fs-promises (.join path % file-name) data opts))
         (lib.promise/then
          (fn []
            {:path (lib.io/kubelt-dir path* folder)
             :mode mode
             :data m})))))))</pre>
				</td>
			</tr>
			<tr>
				<td class="docs">
					<p>Return a function that loads SDK state from a node-specific storage location and returns it as a map. The path to the backing file where the state is stored is passed as the path argument.</p>
				</td>
				<td class="codes">
					<pre class="brush: clojure">(defn- make-restore-fn
  [path*]
  (let [r (t/reader :json)]
    (fn []
      {:post [(lib.promise/promise? %)]}
      (let [opts #js{:encoding &quot;utf8&quot;}]
        (-&gt;
         (lib.io/ensure-kubelt-dir&amp; path* folder)
         (lib.promise/then #(.readFile fs-promises (.join path % file-name) opts))
         (lib.promise/then
          (fn [data-str]
            (let [data (t/read r data-str)]
              data))))))))</pre>
				</td>
			</tr>
			<tr>
				<td class="docs">
					<p>Return the path to the file where state is stored.</p>
				</td>
				<td class="codes">
					<pre class="brush: clojure">(defn- make-path
  [app-name]
  (let [data-path (lib.path/data app-name)]
    (cstr/join &quot;/&quot; [data-path])))</pre>
				</td>
			</tr>
			<tr>
				<td class="docs">
					<h2>Public</h2>
				</td>
				<td class="codes">
					<pre class="brush: clojure"></pre>
				</td>
			</tr>
			<tr>
				<td class="docs">
					<p>Create a configuration storage capability.</p>
				</td>
				<td class="codes">
					<pre class="brush: clojure">(defn create
  [app-name]
  (let [path (make-path app-name)
        store-fn (make-store-fn path)
        restore-fn (make-restore-fn path)]
    (tap&gt; [::create app-name])
    {:com.kubelt/type :kubelt.type/storage
     :storage/path path
     :storage/store-fn store-fn
     :storage/restore-fn restore-fn}))</pre>
				</td>
			</tr>
			<tr>
				<td class="spacer docs">&nbsp;</td>
				<td class="codes" />
			</tr>
		</table>
		<div class="footer">Generated by <a href="https://github.com/captain-porcelain/sidenotes">Sidenotes</a>.&nbsp;&nbsp;Syntax highlighting provided by Alex Gorbatchev's <a href="http://alexgorbatchev.com/SyntaxHighlighter/">SyntaxHighlighter</a>
		</div>
		<script type="text/javascript" src="js/app.js"></script>
	</body>
</html>
